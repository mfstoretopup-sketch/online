<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidioKita - Tempat Nonton Kreatif</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font utama dan memastikan warna latar belakang gelap */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #181818; /* Latar belakang gelap seperti platform video modern */
            color: #ffffff;
        }
        /* Style kustom untuk tombol utama VidioKita */
        .vk-btn-primary {
            background-color: #FF0000; /* Warna utama VidioKita: Merah */
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            border-radius: 9999px; /* Rounded pill shape */
            transition: background-color 0.3s;
        }
        .vk-btn-primary:hover {
            background-color: #e60000;
        }
    </style>
</head>
<body class="antialiased min-h-screen">

    <!-- 1. Header (Navbar) -->
    <header class="sticky top-0 z-10 bg-[#181818] shadow-md px-4 sm:px-8 py-3 flex items-center justify-between">
        <!-- Logo VidioKita -->
        <div class="flex items-center space-x-2 cursor-pointer" onclick="window.switchPage('home')">
            <svg class="w-8 h-8 text-red-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
            </svg>
            <span class="text-xl font-bold text-white">VidioKita</span>
        </div>

        <!-- Search Bar (Pencarian Video) -->
        <div class="hidden md:flex flex-grow max-w-xl mx-8">
            <input type="text" id="search-input" placeholder="Cari video..." class="w-full bg-[#202020] border border-[#303030] text-sm text-gray-300 rounded-l-full py-2 px-4 focus:outline-none focus:border-red-600">
            <button id="search-button" class="bg-[#303030] text-gray-300 px-4 py-2 rounded-r-full hover:bg-[#404040]">
                <!-- Ikon Pencarian -->
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </button>
        </div>

        <!-- Tombol Aksi (Unggah & Login/Profil) -->
        <div class="flex items-center space-x-4">
            <!-- Upload button will be hidden until logged in -->
            <button id="upload-button" class="text-gray-300 hover:text-white transition duration-200 hidden" title="Unggah Video">
                <!-- Ikon Unggah -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            </button>
            
            <!-- Kontainer Dinamis untuk Auth: MASUK atau Profil Pengguna -->
            <div id="auth-container">
                <!-- DEFAULT STATIS: Tombol MASUK dijamin ada saat halaman dimuat -->
                <button id="login-button" class="vk-btn-primary font-medium">MASUK</button>
            </div>
        </div>
    </header>

    <!-- 2. Sidebar (Navigasi Samping) -->
    <div class="flex pt-4">
        <!-- Sidebar Kiri (Hanya terlihat di desktop) -->
        <aside class="hidden lg:block w-56 px-4 space-y-4 border-r border-[#303030] h-full sticky top-16">
            <nav>
                <a href="#" data-page="home" onclick="event.preventDefault(); window.switchPage('home')" class="flex items-center space-x-4 py-2 px-3 rounded-lg hover:bg-[#303030] bg-[#303030] text-white">
                    <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                    <span class="font-medium">Beranda</span>
                </a>
                <a href="#" class="flex items-center space-x-4 py-2 px-3 rounded-lg hover:bg-[#303030] text-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18 10V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4l4 4V6l-4 4z"/></svg>
                    <span class="font-medium">Langganan</span>
                </a>
            </nav>
            <hr class="border-[#303030]">
            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">JELAJAHI</h3>
            <nav class="space-y-1">
                <a href="#" class="flex items-center space-x-4 py-1.5 px-3 rounded-lg hover:bg-[#303030] text-gray-300">Trending</a>
                <a href="#" class="flex items-center space-x-4 py-1.5 px-3 rounded-lg hover:bg-[#303030] text-gray-300">Musik</a>
                <a href="#" class="flex items-center space-x-4 py-1.5 px-3 rounded-lg hover:bg-[#303030] text-gray-300">Game</a>
            </nav>
        </aside>

        <!-- 3. Konten Utama (Page Containers) -->
        <main id="main-content-area" class="flex-grow p-4 sm:p-6">
            
            <!-- 3a. Homepage Content (Feed) -->
            <div id="homepage-content">
                <!-- Judul akan diisi oleh JavaScript (misalnya: "Video Rekomendasi" atau "Hasil Pencarian") -->
                <h2 id="feed-title" class="text-2xl font-bold mb-6">Video Rekomendasi Hari Ini</h2>
                <!-- Grid Video akan diisi oleh JavaScript nanti -->
                <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-4 gap-y-8">
                    <p class="text-center text-gray-500 p-8">Silakan klik tombol "MASUK" untuk mulai menjelajahi video.</p>
                </div>
            </div>

            <!-- 3b. Watch Page Content (Player). Hidden by default. -->
            <div id="watch-page" class="hidden">
                <!-- Content will be rendered by JS -->
            </div>

            <!-- Area untuk pesan status atau error -->
            <div id="status-message" class="mt-8 p-4 bg-gray-700/50 text-gray-300 rounded-lg hidden"></div>
        </main>
    </div>

    <!-- 4. Modal Unggah Video (Hidden by default) -->
    <div id="upload-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#282828] w-full max-w-lg p-6 rounded-xl shadow-2xl relative">
            <h2 class="text-xl font-bold text-white mb-4 border-b border-[#3a3a3a] pb-2">Unggah Video Baru</h2>
            
            <!-- Tombol Tutup -->
            <button id="close-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-white transition duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <form id="upload-form" class="space-y-4">
                <div>
                    <label for="video-title" class="block text-sm font-medium text-gray-300 mb-1">Judul Video</label>
                    <input type="text" id="video-title" required class="w-full bg-[#3a3a3a] border border-[#4a4a4a] text-white p-2.5 rounded-lg focus:outline-none focus:border-red-600">
                </div>
                
                <div>
                    <label for="video-description" class="block text-sm font-medium text-gray-300 mb-1">Deskripsi</label>
                    <textarea id="video-description" rows="3" required class="w-full bg-[#3a3a3a] border border-[#4a4a4a] text-white p-2.5 rounded-lg focus:outline-none focus:border-red-600"></textarea>
                </div>

                <div>
                    <label for="thumbnail-url" class="block text-sm font-medium text-gray-300 mb-1">URL Gambar Thumbnail (Placeholder)</label>
                    <!-- Nilai Default: Placeholder agar mudah diisi -->
                    <input type="url" id="thumbnail-url" value="https://placehold.co/600x337/FF0000/FFFFFF?text=Video Baru" required class="w-full bg-[#3a3a3a] border border-[#4a4a4a] text-white p-2.5 rounded-lg focus:outline-none focus:border-red-600">
                    <p class="text-xs text-gray-400 mt-1">Gunakan URL gambar publik. (Mis: placehold.co)</p>
                </div>
                
                <div>
                    <label for="video-url" class="block text-sm font-medium text-gray-300 mb-1">URL Video (GCS/Simulasi)</label>
                    <!-- Nilai Default: Contoh URL dari Google Cloud Storage -->
                    <input type="url" id="video-url" value="https://storage.googleapis.com/web-dev-course-content/vidio-kita/demo-video-1.mp4" required class="w-full bg-[#3a3a3a] border border-[#4a4a4a] text-white p-2.5 rounded-lg focus:outline-none focus:border-red-600">
                    <p class="text-xs text-gray-400 mt-1">Ini hanya URL simulasi, bukan file upload sebenarnya.</p>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full vk-btn-primary py-2.5 font-bold text-lg rounded-lg">UNGGAH SEKARANG</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Script Sederhana untuk memastikan JavaScript berfungsi -->
    <script>
        console.log("STATUS DIAGNOSTIK: Skrip sederhana (NON-MODULE) berhasil dieksekusi.");
    </script>

    <!-- Modul JavaScript untuk Firebase dan Logika Aplikasi -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, getDoc, setDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- PENGAMANAN & DIAGNOSA KONFIGURASI ---
        
        const appId = typeof __app_id !== 'undefined' && __app_id ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' && __initial_auth_token ? __initial_auth_token : null;
        let firebaseConfig = {};
        
        console.log(`DEBUG KONFIG: Memeriksa variabel lingkungan...`);
        console.log(`DEBUG KONFIG: Status __app_id: ${typeof __app_id !== 'undefined' && __app_id ? 'Ditemukan' : 'Gagal (Default digunakan)'}`);
        console.log(`DEBUG KONFIG: Status __initial_auth_token: ${!!initialAuthToken ? 'Ditemukan' : 'Tidak Ditemukan'}`);


        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("DEBUG KONFIG: __firebase_config berhasil di-parse.");
            } else {
                // FALLBACK: Menggunakan konfigurasi dummy yang aman
                console.warn("DEBUG KONFIG: __firebase_config tidak ditemukan. Menggunakan konfigurasi dummy untuk tes inisialisasi.");
                firebaseConfig = {
                    apiKey: "dummy-key-for-test",
                    authDomain: "dummy.firebaseapp.com",
                    projectId: "dummy-project",
                    appId: appId
                };
            }
        } catch (e) {
            console.error("DEBUG KONFIG ERROR: Gagal mem-parse __firebase_config JSON. Ini bisa menjadi penyebab kegagalan.", e);
            displayMessage("Kesalahan parsing konfigurasi Firebase. Cek console!", true);
            // Menggunakan konfigurasi dummy setelah error parse
            firebaseConfig = { apiKey: "dummy-key-for-test", projectId: "dummy-project", appId: appId };
        }
        
        console.log(`DEBUG KONFIG AKHIR: App ID: ${appId}`);
        console.log(`DEBUG KONFIG AKHIR: Config keys: ${Object.keys(firebaseConfig).join(', ')}`);


        // --- 1. INISIALISASI FIREBASE ---
        
        // Mengaktifkan log debug untuk membantu diagnosis
        setLogLevel('Debug');
        
        try {
            // Jika kode gagal di sini, berarti ada masalah dengan konfigurasi atau import SDK
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            console.log("STATUS DIAGNOSTIK: Firebase SDK berhasil di-import dan di-inisialisasi. Listener harus bekerja sekarang.");
            
            let currentUserId = null;
            let authReady = false;
            
            // Referensi Elemen UI
            const authContainer = document.getElementById('auth-container');
            const videoGrid = document.getElementById('video-grid');
            const feedTitle = document.getElementById('feed-title');
            const statusMessage = document.getElementById('status-message');
            const uploadButton = document.getElementById('upload-button');
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');

            // Referensi Halaman
            const homepageContent = document.getElementById('homepage-content');
            const watchPage = document.getElementById('watch-page');

            // Referensi untuk Modal Unggah
            const uploadModal = document.getElementById('upload-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const uploadForm = document.getElementById('upload-form');
            
            /** Menampilkan pesan status di UI */
            function displayMessage(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.className = `mt-8 p-4 rounded-lg block ${isError ? 'bg-red-900 text-red-200' : 'bg-green-900 text-green-200'}`;
                statusMessage.classList.remove('hidden');
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 5000);
            }

            // --- 2. FUNGSI OTENTIKASI ---
            
            async function handleAuth() {
                console.log("DEBUG: Fungsi handleAuth() dipanggil setelah klik MASUK.");
                
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        displayMessage("Login berhasil dengan token khusus.");
                    } else {
                        // Coba masuk secara anonim sebagai fallback
                        await signInAnonymously(auth);
                        displayMessage("Login sebagai pengguna anonim berhasil.");
                    }
                    console.log("DEBUG: Autentikasi selesai. Memperbarui UI.");
                } catch (error) {
                    console.error("DEBUG: Kesalahan saat autentikasi Firebase. Cek koneksi Anda!", error);
                    displayMessage(`Gagal melakukan login: ${error.message}. Cek Console untuk detail lebih lanjut.`, true);
                }
            }
            
            function handleLogout() {
                signOut(auth).then(() => {
                    displayMessage("Anda telah log out.");
                    switchPage('home');
                }).catch((error) => {
                    console.error("Kesalahan saat logout:", error);
                    displayMessage(`Gagal logout: ${error.message}`, true);
                });
            }
            
            // --- 3. LOGIKA UNTUK DUMMY DATA ---

            async function createInitialDummyVideo() {
                if (!currentUserId) {
                    displayMessage("Anda harus login untuk membuat video dummy.", true);
                    return;
                }
                try {
                    const videosColRef = collection(db, 'artifacts', appId, 'public', 'data', 'videos');
                    
                    // Video 1
                    await setDoc(doc(videosColRef, "dummy-1"), {
                        user_id: currentUserId,
                        title: "Perkenalan VidioKita: Proyek Web Streaming",
                        description: "Ini adalah video dummy awal untuk mengisi tampilan VidioKita. Silakan unggah video Anda sendiri!",
                        thumbnail_url: "https://placehold.co/600x337/FF0000/FFFFFF?text=VIDIOKITA",
                        view_count: 100,
                        duration: "02:30",
                        upload_date: new Date(),
                        gcs_url: "https://storage.googleapis.com/web-dev-course-content/vidio-kita/demo-video-1.mp4" 
                    });
                    
                    // Video 2
                    await setDoc(doc(videosColRef, "dummy-2"), {
                        user_id: currentUserId,
                        title: "Tutorial Coding Dasar HTML dan CSS",
                        description: "Contoh tutorial coding untuk pemula. Pelajari cara membuat website.",
                        thumbnail_url: "https://placehold.co/600x337/333333/FFFFFF?text=CODING",
                        view_count: 50,
                        duration: "15:45",
                        upload_date: new Date(Date.now() - 86400000), // 1 hari lalu
                        gcs_url: "https://storage.googleapis.com/web-dev-course-content/vidio-kita/demo-video-2.mp4" 
                    });

                    // Video 3 (Tambahan untuk Pencarian)
                    await setDoc(doc(videosColRef, "dummy-3"), {
                        user_id: currentUserId,
                        title: "Membangun Aplikasi dengan Javascript",
                        description: "Langkah-langkah membangun aplikasi web dengan murni Javascript.",
                        thumbnail_url: "https://placehold.co/600x337/007ACC/FFFFFF?text=JS+APP",
                        view_count: 10,
                        duration: "05:10",
                        upload_date: new Date(Date.now() - 172800000), // 2 hari lalu
                        gcs_url: "https://storage.googleapis.com/web-dev-course-content/vidio-kita/demo-video-1.mp4" 
                    });

                    displayMessage("Tiga video dummy berhasil dibuat di database publik!");
                } catch (e) {
                    console.error("Gagal membuat video dummy:", e);
                    displayMessage(`Gagal membuat video dummy: ${e.message}`, true);
                }
            }

            // --- 4. PEMBARUAN UI BERDASARKAN STATUS AUTH ---

            /** Memperbarui header navigasi berdasarkan status login */
            function updateAuthUI(user) {
                authContainer.innerHTML = '';
                
                if (user) {
                    currentUserId = user.uid;
                    uploadButton.classList.remove('hidden'); 
                    
                    // Menampilkan avatar dan dropdown/info pengguna
                    authContainer.innerHTML = `
                        <div class="relative group">
                            <button class="flex items-center space-x-2 p-2 rounded-full bg-red-600 hover:bg-red-700 transition duration-200" title="Profil Pengguna">
                                <span class="text-sm font-semibold">${currentUserId.substring(0, 6)}...</span>
                                <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-red-600 font-bold text-lg">${currentUserId[0].toUpperCase()}</div>
                            </button>
                            <!-- Menu dropdown sederhana -->
                            <div class="absolute right-0 mt-2 w-56 bg-[#282828] rounded-lg shadow-xl py-1 hidden group-hover:block z-20">
                                <p class="px-4 py-2 text-xs text-gray-400 border-b border-[#303030] overflow-hidden truncate">ID: ${currentUserId}</p>
                                <button id="create-dummy-button" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-[#3a3a3a]">
                                    Buat Dummy Video (Tes)
                                </button>
                                <button id="logout-dropdown-button" class="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-[#3a3a3a]">Logout</button>
                            </div>
                        </div>
                    `;
                    
                    // Catatan: Tombol Logout dan Dummy akan dipasang listener SEMENTARA di sini untuk fallback, 
                    // tetapi tombol MASUK TIDAK perlu dipasang listener di sini karena ditangani oleh DELEGATION di akhir script.
                    document.getElementById('logout-dropdown-button')?.addEventListener('click', handleLogout);
                    document.getElementById('create-dummy-button')?.addEventListener('click', createInitialDummyVideo);

                    // Memuat data video setelah login
                    if (authReady) {
                        loadVideos(); // Memuat feed utama saat login
                    }

                } else {
                    currentUserId = null;
                    uploadButton.classList.add('hidden'); 
                    
                    // Menampilkan tombol MASUK (Listener ditangani oleh Event Delegation)
                    authContainer.innerHTML = `<button id="login-button" class="vk-btn-primary font-medium">MASUK</button>`;
                    
                    // Hapus konten video dan tampilkan pesan ajakan
                    videoGrid.innerHTML = '<p class="text-center text-gray-500 p-8">Silakan klik **MASUK** untuk melihat video.</p>';
                }
            }

            // Listener status otentikasi
            onAuthStateChanged(auth, (user) => {
                authReady = true;
                updateAuthUI(user);
            });

            // --- 5. LOGIKA NAVIGASI HALAMAN ---

            /** Mengubah tampilan antara halaman utama (feed) dan halaman tonton (player) */
            window.switchPage = function(pageId) {
                homepageContent.classList.add('hidden');
                watchPage.classList.add('hidden');
                
                // Tampilkan halaman yang diminta
                if (pageId === 'home') {
                    homepageContent.classList.remove('hidden');
                    // Atur ulang pencarian saat kembali ke Beranda
                    searchInput.value = '';
                    loadVideos(); 
                    // Update tampilan tombol sidebar (Beranda)
                    document.querySelector('aside a[data-page="home"]').classList.add('bg-[#303030]', 'text-white');
                } else if (pageId === 'watch') {
                    watchPage.classList.remove('hidden');
                    // Hapus highlight dari tombol sidebar saat di halaman tonton
                    document.querySelector('aside a[data-page="home"]').classList.remove('bg-[#303030]', 'text-white');
                }
            }

            // Fungsi untuk navigasi ke halaman tonton
            window.navigateToWatchPage = async function(videoId) {
                if (!currentUserId) {
                    displayMessage("Anda harus login untuk menonton video.", true);
                    return;
                }

                try {
                    const videoDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'videos', videoId);
                    const docSnap = await getDoc(videoDocRef);

                    if (docSnap.exists()) {
                        const video = docSnap.data();
                        
                        // 1. Tambah view count (simulasi)
                        const newViewCount = (video.view_count || 0) + 1;
                        await updateDoc(videoDocRef, { view_count: newViewCount });
                        
                        // 2. Render Watch Page
                        renderWatchPage(videoId, { ...video, view_count: newViewCount });
                        switchPage('watch');

                    } else {
                        displayMessage("Video tidak ditemukan.", true);
                    }
                } catch (e) {
                    console.error("Gagal memuat halaman tonton:", e);
                    displayMessage(`Gagal memuat video: ${e.message}`, true);
                }
            }
            
            // --- 6. LOGIKA PENCARIAN ---
            
            /** Menangani proses pencarian saat tombol diklik atau Enter ditekan */
            function handleSearch() {
                const queryText = searchInput.value.trim().toLowerCase();
                
                // Pindah ke halaman beranda (untuk menampilkan hasil)
                if (homepageContent.classList.contains('hidden')) {
                    switchPage('home');
                }

                // Memuat video dengan filter pencarian
                loadVideos(queryText);
            }

            // --- 7. LOGIKA MODAL & UPLOAD (FIREBASE WRITE) ---

            /** Membuka modal unggah video */
            function openUploadModal() {
                if (currentUserId) {
                    uploadModal.classList.remove('hidden');
                } else {
                    displayMessage("Anda harus masuk (Login) untuk mengunggah video.", true);
                }
            }

            /** Menutup modal unggah video */
            function closeUploadModal() {
                uploadModal.classList.add('hidden');
                uploadForm.reset(); 
            }

            /** Menangani pengiriman formulir unggah dan menyimpan data ke Firestore */
            async function handleVideoUpload(event) {
                event.preventDefault(); 

                if (!currentUserId) {
                    displayMessage("Kesalahan: ID pengguna tidak tersedia. Silakan login ulang.", true);
                    return;
                }
                
                const title = document.getElementById('video-title').value.trim();
                const description = document.getElementById('video-description').value.trim();
                const thumbnailUrl = document.getElementById('thumbnail-url').value.trim();
                const videoUrl = document.getElementById('video-url').value.trim();
                
                if (!title || !thumbnailUrl || !videoUrl || !description) {
                    displayMessage("Semua kolom harus diisi (Judul, Deskripsi, Thumbnail URL, Video URL).", true);
                    return;
                }

                try {
                    // Tentukan koleksi publik untuk video
                    const videosColRef = collection(db, 'artifacts', appId, 'public', 'data', 'videos');
                    
                    // Tambahkan dokumen baru ke koleksi
                    await addDoc(videosColRef, {
                        user_id: currentUserId,
                        title: title,
                        description: description,
                        thumbnail_url: thumbnailUrl,
                        view_count: 0, 
                        duration: "00:00", // Waktu dummy
                        upload_date: new Date(),
                        gcs_url: videoUrl 
                    });

                    displayMessage(`Video "${title}" berhasil diunggah dan disimpan ke database!`);
                    closeUploadModal();

                } catch (e) {
                    console.error("Gagal mengunggah video:", e);
                    displayMessage(`Gagal mengunggah video: ${e.message}`, true);
                }
            }

            // --- 8. LOGIKA PENGAMBILAN DATA (Video Firestore) ---

            /**
             * Mengambil data video dari Firestore secara real-time.
             */
            function loadVideos(searchQuery = '') {
                if (!currentUserId) return; 
                
                const videosColRef = collection(db, 'artifacts', appId, 'public', 'data', 'videos');
                let q = query(videosColRef);
                
                if (searchQuery) {
                    feedTitle.textContent = `Hasil Pencarian untuk: "${searchQuery}"`;
                } else {
                    feedTitle.textContent = "Video Rekomendasi Hari Ini";
                }

                onSnapshot(q, (snapshot) => {
                    let videoData = [];
                    snapshot.forEach((doc) => {
                        videoData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // --- KLIEN FILTERING (Pencarian) ---
                    if (searchQuery) {
                        const lowerQuery = searchQuery.toLowerCase();
                        videoData = videoData.filter(video => 
                            video.title.toLowerCase().includes(lowerQuery)
                        );
                    }
                    // --- END KLIEN FILTERING ---

                    // Urutkan data berdasarkan tanggal unggah secara descending (terbaru di atas)
                    videoData.sort((a, b) => {
                        // Penanganan properti upload_date yang mungkin merupakan timestamp atau objek Date
                        const dateA = a.upload_date?.seconds ? a.upload_date.seconds * 1000 : (a.upload_date instanceof Date ? a.upload_date.getTime() : 0);
                        const dateB = b.upload_date?.seconds ? b.upload_date.seconds * 1000 : (b.upload_date instanceof Date ? b.upload_date.getTime() : 0);
                        return dateB - dateA;
                    });
                    
                    renderVideoGrid(videoData, searchQuery);
                    
                    if (videoData.length === 0 && !searchQuery) {
                        displayMessage("Tidak ada video yang ditemukan. Silakan klik tombol 'Buat Dummy Video' di menu profil Anda.");
                    }
                }, (error) => {
                    console.error("Gagal memuat video:", error);
                    displayMessage(`Gagal memuat video: ${error.message}`, true);
                });
            }
            
            // --- 9. LOGIKA RENDERING UI ---
            
            /** Render video ke grid di halaman utama */
            function renderVideoGrid(videos, searchQuery = '') {
                if (!videos || videos.length === 0) {
                    if (searchQuery) {
                        videoGrid.innerHTML = `<p class="text-center text-gray-500 p-8">Tidak ada video yang cocok dengan kata kunci: **${searchQuery}**.</p>`;
                    } else {
                        videoGrid.innerHTML = '<p class="text-center text-gray-500 p-8">Saat ini belum ada video. Silakan buat video dummy atau unggah video.</p>';
                    }
                    return;
                }
                
                videoGrid.innerHTML = videos.map(video => {
                    const views = (video.view_count || 0).toLocaleString('id-ID');
                    
                    // Mengambil tanggal
                    let uploadDate = 'Tanggal tidak tersedia';
                    const uploadDateObject = video.upload_date;
                    if (uploadDateObject) {
                        // Cek jika ini adalah objek Timestamp Firestore
                        const dateMillis = uploadDateObject.seconds ? uploadDateObject.seconds * 1000 : (uploadDateObject instanceof Date ? uploadDateObject.getTime() : new Date().getTime());
                        uploadDate = new Date(dateMillis).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                    }
                    
                    return `
                        <div class="video-card cursor-pointer group" onclick="window.navigateToWatchPage('${video.id}')">
                            <!-- Thumbnail -->
                            <div class="relative w-full aspect-video rounded-xl overflow-hidden bg-[#303030] transition-all duration-300">
                                <img src="${video.thumbnail_url}" alt="${video.title}" onerror="this.onerror=null;this.src='https://placehold.co/600x337/303030/FFFFFF?text=Error+Load'" class="w-full h-full object-cover">
                                <!-- Durasi Video -->
                                <span class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded">${video.duration || '00:00'}</span>
                            </div>
                            <!-- Detail Video -->
                            <div class="flex mt-3 space-x-3">
                                <!-- Avatar Channel (Placeholder) -->
                                <div class="w-9 h-9 rounded-full bg-red-600 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">VK</div>
                                <div>
                                    <h3 class="text-white text-base font-semibold line-clamp-2">${video.title}</h3>
                                    <p class="text-gray-400 text-sm mt-1">Pengunggah ID: ${(video.user_id || 'Anonim').substring(0, 6)}...</p>
                                    <p class="text-gray-500 text-xs">${views} x ditonton • ${uploadDate}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            /** Render halaman detail video */
            function renderWatchPage(videoId, video) {
                const views = (video.view_count || 0).toLocaleString('id-ID');
                
                // Mengambil tanggal
                let uploadDate = 'Tanggal tidak tersedia';
                const uploadDateObject = video.upload_date;
                if (uploadDateObject) {
                    const dateMillis = uploadDateObject.seconds ? uploadDateObject.seconds * 1000 : (uploadDateObject instanceof Date ? uploadDateObject.getTime() : new Date().getTime());
                    uploadDate = new Date(dateMillis).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                }
                
                watchPage.innerHTML = `
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Kolom Kiri: Player & Detail -->
                        <div class="lg:w-2/3">
                            <!-- Video Player (Simulasi menggunakan tag video HTML5) -->
                            <div class="aspect-video bg-black rounded-xl overflow-hidden mb-4">
                                <!-- Menggunakan gcs_url sebagai sumber video -->
                                <video controls class="w-full h-full" poster="${video.thumbnail_url}">
                                    <source src="${video.gcs_url}" type="video/mp4">
                                    Maaf, browser Anda tidak mendukung tag video. (URL: ${video.gcs_url})
                                </video>
                            </div>

                            <!-- Judul & Aksi -->
                            <h1 class="text-2xl font-bold mb-2">${video.title}</h1>
                            <div class="flex items-center justify-between border-b border-[#303030] pb-3 mb-3">
                                <div class="flex items-center space-x-3">
                                    <!-- Avatar Channel -->
                                    <div class="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center text-white text-lg font-bold flex-shrink-0">VK</div>
                                    <div>
                                        <p class="text-sm font-semibold">Channel ID: ${(video.user_id || 'Anonim').substring(0, 6)}...</p>
                                        <p class="text-xs text-gray-400">${views} x ditonton • ${uploadDate}</p>
                                    </div>
                                </div>
                                <!-- Tombol Aksi Simulasi -->
                                <div class="flex space-x-3">
                                    <button class="flex items-center space-x-1.5 p-2 rounded-full bg-[#3a3a3a] text-white hover:bg-[#4a4a4a] text-sm">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.021-.49-.06l-4.017-1.127a2 2 0 01-1.352-2.071V8.243a2 2 0 011.517-1.93l4.5-1.125a2 2 0 012.015.698l.643 1.054A2 2 0 0114 10z"/></svg>
                                        <span>Suka</span>
                                    </button>
                                    <button class="flex items-center space-x-1.5 p-2 rounded-full bg-[#3a3a3a] text-white hover:bg-[#4a4a4a] text-sm">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342M12 19.916L9.66 18c-2.403-1.625-5.327-2.9-7.387-3.922a1.002 1.002 0 01-.194-1.255l.896-.896a1.002 1.002 0 011.332-.089C5.462 13.91 8 15.617 8 15.617h8s2.538-1.707 5.753-4.329a1.002 1.002 0 011.332.089l.896.896a1.002 1.002 0 01-.194 1.255c-2.06 1.022-4.984 2.297-7.387 3.922L12 19.916zm0 0V4.084M12 12h.01"/></svg>
                                        <span>Bagikan</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Deskripsi Video -->
                            <div class="bg-[#3a3a3a] p-3 rounded-lg text-sm whitespace-pre-wrap">
                                <p class="font-semibold mb-2">Deskripsi:</p>
                                <p>${video.description || 'Tidak ada deskripsi.'}</p>
                            </div>
                        </div>

                        <!-- Kolom Kanan: Video Terkait (Simulasi) -->
                        <div class="lg:w-1/3">
                            <h3 class="text-xl font-bold mb-4">Video Terkait (Simulasi)</h3>
                            <div class="space-y-4">
                                <!-- Placeholder Video Terkait 1 - Mengarahkan ke video lain -->
                                <div class="flex space-x-3 cursor-pointer p-2 rounded-lg hover:bg-[#3a3a3a]" onclick="window.navigateToWatchPage('dummy-2')">
                                    <img src="https://placehold.co/120x67/101010/FFFFFF?text=Terkait+1" class="w-32 h-18 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/120x67/303030/FFFFFF?text=Error'">
                                    <div>
                                        <p class="text-sm font-semibold line-clamp-2">Tutorial Coding Dasar</p>
                                        <p class="text-xs text-gray-400">Channel Terkait</p>
                                    </div>
                                </div>
                                <!-- Placeholder Video Terkait 2 - Mengarahkan ke video lain -->
                                <div class="flex space-x-3 cursor-pointer p-2 rounded-lg hover:bg-[#3a3a3a]" onclick="window.navigateToWatchPage('dummy-3')">
                                    <img src="https://placehold.co/120x67/101010/FFFFFF?text=Terkait+2" class="w-32 h-18 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/120x67/303030/FFFFFF?text=Error'">
                                    <div>
                                        <p class="text-sm font-semibold line-clamp-2">Membangun Aplikasi dengan JS</p>
                                        <p class="text-xs text-gray-400">Channel Lain</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }


            // --- 10. EVENT LISTENERS APLIKASI (DELEGASI & INITIAL) ---

            document.addEventListener('DOMContentLoaded', () => {
                // Tombol Unggah di Header
                uploadButton.addEventListener('click', openUploadModal);
                
                // Tombol Tutup Modal (X)
                closeModalButton.addEventListener('click', closeUploadModal);

                // Submit Form Unggah
                uploadForm.addEventListener('submit', handleVideoUpload);
                
                // Tombol Pencarian
                searchButton.addEventListener('click', handleSearch);

                // Enter di input Pencarian
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                });
                
                console.log("STATUS DIAGNOSTIK: Semua Event Listeners (non-delegasi) telah dipasang.");
            });
            
            
            // ** EVENT DELEGATION UNTUK TOMBOL LOGIN/LOGOUT (Fix) **
            document.body.addEventListener('click', (e) => {
                // 1. Tangani Tombol MASUK (ID: login-button)
                if (e.target && e.target.id === 'login-button') {
                    e.preventDefault();
                    console.log("DEBUG DELEGATION: Tombol MASUK terdeteksi via delegation.");
                    handleAuth();
                }
                // 2. Tangani Tombol LOGOUT di Dropdown (ID: logout-dropdown-button)
                else if (e.target && e.target.id === 'logout-dropdown-button') {
                    e.preventDefault();
                    console.log("DEBUG DELEGATION: Tombol LOGOUT terdeteksi via delegation.");
                    handleLogout();
                }
                // 3. Tangani Tombol Buat Dummy di Dropdown
                 else if (e.target && e.target.id === 'create-dummy-button') {
                    e.preventDefault();
                    console.log("DEBUG DELEGATION: Tombol Buat Dummy terdeteksi via delegation.");
                    createInitialDummyVideo();
                }
            });

            // onAuthStateChanged tetap di luar DOMContentLoaded agar langsung aktif
            onAuthStateChanged(auth, (user) => {
                authReady = true;
                updateAuthUI(user);
            });
            
        } catch (e) {
            console.error("KESALAHAN FATAL DALAM BLOK MODULE. Semua tombol akan mati:", e);
            displayMessage("Aplikasi gagal dimuat! Cek Console (F12) untuk kesalahan import Firebase SDK atau inisialisasi.", true);
        }
    </script>
</body>
</html>
